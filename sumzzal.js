!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var i=t();for(var a in i)("object"==typeof exports?exports:e)[a]=i[a]}}(window,(()=>(()=>{"use strict";var e={d:(t,i)=>{for(var a in i)e.o(i,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:i[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{FLAG_LENGTH:()=>c,HEADER_MINIMUM_LENGTH:()=>o,HEADHEIGHT_INDEX:()=>n,IDENTIFIER_LENGTH:()=>_,IV_LENGTH:()=>p,KEY_LENGTH:()=>y,NUMBER_LENGTH:()=>l,SMZZL_IDENTIFIER:()=>a,SMZZL_VERSION:()=>i,TAGLENGTHBITS:()=>s,TAG_LENGTH:()=>u,TAILHEIGHT_INDEX:()=>r,VERSION_LENGTH:()=>d,default:()=>f});const i=2,a=[83,77,90,90,76],s=128,n=80,r=84,o=92,_=5,d=1,c=2,l=4,p=16,u=16,y=32,g=new TextEncoder;function m(e,t){const i=t-e+1,a=Math.random()*i;return Math.min(e+Math.floor(a),t)}function v(e){return new Uint8ClampedArray([e>>24&255,e>>16&255,e>>8&255,255&e])}class f{_debug;_canvas;_ctx;_data=[];_result=[];available=!0;_encrypted;_usePassword;_keyBytes;_iv;_tag;_previewData;_removedPreview=[];_totalRemoved;_headHeight;_tailHeight;constructor(e){this._debug=e??console.log;const t=document.createElement("canvas");this._canvas=t;const i=t.getContext("2d");this._ctx=i,i.imageSmoothingEnabled=!1,i.mozImageSmoothingEnabled=!1,i.webkitImageSmoothingEnabled=!1,i.msImageSmoothingEnabled=!1,"undefined"==typeof window?(e("window undefined"),this.available=!1):void 0===window.crypto.subtle&&(e("subtle undefined"),this.available=!1)}get _imageData(){const e=this._width,t=this._height;return Array.from(this._ctx.getImageData(0,0,e,t).data)}get _width(){return this._canvas.width}get _height(){return this._canvas.height}_removeAlpha(){for(let e=3;e<array.length;e+=3)this._data.splice(e,1)}async _putData(e){this._canvas.width=e.width,this._canvas.height=e.height,this._ctx.drawImage(await createImageBitmap(e),0,0),this._data=this._imageData}_resetData(){this._data.length=0,this._result.length=0}_encodeHeader(){const e=this._result;e.push(...a),e.push(i);let t,s=0;for(t of(this._usePassword&&(s|=32768),e.push(s>>8,255&s),e.push(...v(this._width)),e.push(...v(this._height)),e.push(...new Uint8ClampedArray(this._iv)),e.push(...new Uint8ClampedArray(this._tag)),e.push(...new Uint8ClampedArray(this._keyBytes)),e.push(...v(0)),e.push(...v(0)),e.push(...v(this._previewData.length*l)),this._previewData))e.push(...v(t));const r=Math.ceil(e.length/(3*this._width));this._headHeight=r,this._tailHeight=0,function(e,t,i){for(let a=0;a<t.length;a++)e[i+a]=t[a]}(e,v(r),n);const o=3*r*this._width-e.length;for(let t=0;t<o;t++)e.push(m(0,255))}_append(){this._result=this._result.concat(this._encrypted)}_removePreview(e,t){this._previewData=e;const i=t.length;let a,s=0,n=0,r=!1;for(a of e)a*=3,r&&(this._removedPreview.push(t.splice(s-n,a)),n+=a),s+=a,r=!r;return r&&(a=3*(i-s),this._removedPreview.push(t.splice(s-n,a)),n+=a),this._totalRemoved=n/3,t}_restorePreview(e){let t,i=0,a=0,s=!1;for(t of this._previewData)t*=3,s&&(e.splice(i,0,this._removedPreview(a)),a++),i+=t,s=!s;return s&&e.splice(i,0,this._removedPreview[a]),e}async encrypt(e,t=[]){return this._resetData(),await this._putData(e,w,h),this._removeAlpha(),this.data=this._removePreview(t,this._data),await this._encrypt(),this._encrypted=this._restorePreview(this._encrypted),this._encodeHeader(),this._append(),await this._encodePng()}async _encrypt(e){let t;"string"==typeof e&&e?(t=await async function(e,t=y){const i=g.encode(e),a=await window.crypto.subtle.digest("SHA-256",i);return new Uint8Array(a).slice(0,t)}(e),this._usePassword=!0,this._keyBytes=new Array(y).fill(0)):(t=window.crypto.getRandomValues(new Uint8Array(y)),this._usePassword=!1,this._keyBytes=t);const i=await window.crypto.subtle.importKey("raw",t,"AES-GCM",!1,["encrypt","decrypt"]),a=window.crypto.getRandomValues(new Uint8Array(p));this._iv=a;const n=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:a,tagLength:s},i,this._data);this._tag=function(e,t=s){return e.slice(e.byteLength-(t+7>>3))}(n,s);const r=new Uint8ClampedArray(n);this._encrypted=r.slice(0,r.length-u)}decrypt(e){}async _encodePng(){return""}}return t})()));